# 작업 기록 통합 문서

**최종 업데이트**: 2025-12-10

---

## 📌 현재 작업 상태

### 🔨 다음 작업: 원콜(ONECALL) 자동배차 계속

**완료된 작업**:
- RegistOrderModeAsync 신규 접수 구현 완료
  - 상차지/하차지/화물정보/운임/톤수/차종/결재/화물중량/구분 체크박스 입력
  - 저장버튼 클릭 및 저장 확인 (밝기 변화 감지)
  - 오더번호 OFR → Kai DB Onecall 필드 업데이트

**다음 작업**:
- UpdateOrderModeAsync 수정 모드 구현
- 또는 테스트 및 안정화

**공용함수** (OnecallAct_RcptRegPage.UI.cs):
- `SelectComboBoxItemAsync` - 콤보박스 선택 (재시도 + OFR 검증)
- `Set상세주소Async` - 상차지/하차지 입력 (재시도 + OFR 검증)
- `SetCheckBoxAsync` - 체크박스 설정 (OFR 기반, 재시도)
- `Get오더번호Async` - 데이터그리드 오더번호 OFR (컬럼 인덱스 2)
- `GetCarWeightResult`, `GetTruckDetailResult`, `GetFeeTypeResult` - 매핑 함수

**핸들 초기화** (OnecallInfo_Mem.cs):
- 접수섹션_구분_hWnd독차/혼적/긴급/왕복/경유
- 접수섹션_hWnd신규버튼/저장버튼/취소버튼

**참고 파일**:
- 원콜: `OnecallAct_RcptRegPage.cs`, `OnecallAct_RcptRegPage.UI.cs`
- 인성/화물24시 (참고용)

---

## ✅ 최근 완료 작업 요약

### 2025-12-10
- **RegistOrderModeAsync 저장 확인 구현**
  - 저장버튼 클릭 후 밝기 변화로 저장 완료 감지
  - 오더번호 OFR (Get오더번호Async) - DG오더_rcRelSmallCells[col, row] 순서
  - Kai DB Onecall 필드 업데이트 (SrResult_Order_UpdateRowAsync_Today_WithRequestId)
- **데이터그리드 배열 순서 통일**: `[row, col]` → `[col, row]` (화물24시와 동일)
- **취소버튼 핸들 추가**: `FindWindowEx`로 "화물취소" 버튼 찾기 (Disabled 상태에서도 가능)

### 2025-12-09
- **SetCheckBoxAsync** 체크박스 공용함수 추가 (OFR 기반 읽기/쓰기)
- **공용함수 재시도 패턴** 통일 (for i=1~c_nRepeatShort, bEdit=마지막만)
  - SelectComboBoxItemAsync, Set상세주소Async, SetCheckBoxAsync
- **체크박스 핸들** 초기화 추가 (독차/혼적/긴급/왕복/경유)
- **using 패턴** 적용 (SelectComboBoxItemAsync - Bitmap 자동 Dispose)

### 2025-12-08
- **SelectComboBoxItemAsync** 콤보박스 공용함수 (드롭다운 열기/선택/닫힘 대기)
- **접수등록Page_접수_톤수Open** 배열 추가 (CommonModel_ComboBox)
- **차량정보 핸들** 초기화 추가 (톤수/차종/대수/결재)
- RegistOrderModeAsync 톤수 콤보박스 선택 적용

### 2025-12-06
- **Set운송비Async** 공용함수 (운송비구분 라디오 + 운송비합계 Edit)
- **CancelAndWaitClosedAsync** 화물취소용 (버튼 Disabled 대기 + 닫기 클릭)
- **SaveAndWaitClosedAsync** 개선 (buttonName 파라미터, 딜레이 패턴, IsWindowVisible 필터)
- **UpdateOrderToPopupAsync** 화물취소/배차취소 분리

### 2025-12-05
- SaveAndWaitClosedAsync 공용함수 구현
- UpdateOrderToPopupAsync 선택적 수정 (밝기 기반 로딩 감지, 차량톤수 라디오버튼)

### 2025-12-04
- Cargo24 확인창/보고창 공용함수 (ClickConfirmYesButtonAsync, ClickReportOkButtonAsync)
- UpdateOrderToPopupAsync 상태변경 처리 (화물취소, 배차취소)

### 2025-12-02
- OFR avgBright 가중치 문제 해결 (0.9→0.7, 회색배경용)
- Cargo24 페이지별 리스트 검사 구조 구현

---

## 🔧 미적용 (대기 중)

- **Std32Mouse_Send.cs:195** - `BlockInput(true)` → `BlockInput(false)` 수정 필요

---

## 📊 참고: RegistOrderModeAsync 구조 (원콜)

```
#region 1. 신규 버튼 클릭
#region 2. 정보 입력
  - 2-1. 상차지 (권역 + 상세주소)
  - 2-2. 하차지 (권역 + 상세주소)
  - 2-3. 화물정보
  - 2-4. 운임
  - 2-5. 톤수 콤보박스
  - 2-6. 차종 콤보박스
  - 2-7. 대수
  - 2-8. 결재 콤보박스
  - 2-9. 화물중량
  - 2-10. 구분 체크박스 (독차/혼적/긴급/왕복/경유)
#region 3. 저장 버튼 클릭 + 밝기 변화 대기
#region 4. 저장 성공 확인
  - 4-1. 오더번호 OFR (Get오더번호Async)
  - 4-2. 사전 체크 (KeyCode, Onecall 중복, SignalR 연결)
  - 4-3. Kai DB Onecall 필드 업데이트
```

---

## 📊 참고: 인성 자동배차 구조

**핵심 함수**: CheckIsOrderAsync_InsungOrderManage → 접수Or배차/운행/완료/취소 분기

**40초 타이머**: 운행 진입 시 RunStartTime 설정, 40초 경과 시 Kai DB 업데이트

---

## 📋 참고: Datagrid 배열 순서

**화물24시/원콜 통일**: `DG오더_rcRelCells[col, row]` (컬럼 먼저, 로우 나중)

**상수**: HEADER_HEIGHT=30, TARGET_ROW=2, OFR_HEIGHT=20, MIN_COLUMN_WIDTH=30

---

## 🔗 최근 커밋

- (예정) - feat: 원콜 RegistOrderModeAsync 저장 확인 및 DB 업데이트 구현
- `45446fb` - feat: 원콜 체크박스 공용함수 및 재시도 패턴 개선
- `f474b69` - docs: 2025-12-08 작업 기록 업데이트
- `7f0dece` - feat: 원콜 콤보박스 공용함수 SelectComboBoxItemAsync 추가
- `daa67e9` - feat: 원콜 자동배차 RegistOrderModeAsync 기본 구조 구현
- `31d3943` - docs: 2025-12-06 작업 기록 업데이트 및 원콜 자동배차 계획

---
