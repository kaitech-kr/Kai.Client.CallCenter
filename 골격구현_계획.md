# ê³¨ê²© êµ¬í˜„ ê³„íš

## ğŸ¯ ëª©í‘œ: ìƒí™©ë³„ ë¶„ê¸°ë§Œ ëª…í™•íˆ + ê³¨ê²©ë§Œ êµ¬í˜„

---

## ğŸ“ í•µì‹¬ ë¶„ê¸° ë¡œì§ (5ê°€ì§€ë§Œ)

```csharp
string kaiState = item.NewOrder.OrderState;
string insungState = dgInfo.sStatus;

// ===== ë¶„ê¸° 1: Kai ì ‘ìˆ˜ + Insung ì ‘ìˆ˜/ë°°ì°¨ =====
if (kaiState == "ì ‘ìˆ˜" && (insungState == "ì ‘ìˆ˜" || insungState == "ë°°ì°¨"))
{
    // íƒ€ì´ë¨¸ ë¦¬ì…‹ (ìˆì—ˆë‹¤ë©´)
    if (item.RunStartTime != null)
        item.RunStartTime = null;

    return SuccessAndReEnqueue();
}

// ===== ë¶„ê¸° 2: Kai ì ‘ìˆ˜ + Insung ìš´í–‰ =====
if (kaiState == "ì ‘ìˆ˜" && insungState == "ìš´í–‰")
{
    // 2-1. íƒ€ì´ë¨¸ ì‹œì‘
    if (item.RunStartTime == null)
    {
        item.RunStartTime = DateTime.Now;
        return SuccessAndReEnqueue();
    }

    // 2-2. íƒ€ì´ë¨¸ ì²´í¬
    TimeSpan elapsed = DateTime.Now - item.RunStartTime.Value;
    if (elapsed.TotalSeconds >= 40)
    {
        // 40ì´ˆ ê²½ê³¼! â†’ Kai ë°°ì°¨ë¡œ ì—…ë°ì´íŠ¸ + ë‹¤ë¥¸ ì•± ì²˜ë¦¬
        // TODO: ì¶©ëŒ ì²´í¬ (Phase 2ì—ì„œ ì¶”ê°€)
        await UpdateKaiStateAsync(item, "ë°°ì°¨");
        await CancelOtherAppsAsync(item, ctrl);
        item.RunStartTime = null;
        return SuccessAndReEnqueue();
    }

    return SuccessAndReEnqueue();
}

// ===== ë¶„ê¸° 3: Kai ë°°ì°¨ + Insung ì™„ë£Œ =====
if (kaiState == "ë°°ì°¨" && insungState == "ì™„ë£Œ")
{
    await UpdateKaiStateAsync(item, "ì™„ë£Œ");
    return SuccessAndComplete("ë°°ì†¡ ì™„ë£Œ");
}

// ===== ë¶„ê¸° 4: Insung ì·¨ì†Œ =====
if (insungState == "ì·¨ì†Œ")
{
    await UpdateKaiStateAsync(item, "ì·¨ì†Œ");
    await CancelOtherAppsAsync(item, ctrl);
    return SuccessAndComplete("ì£¼ë¬¸ ì·¨ì†Œ");
}

// ===== ë¶„ê¸° 5: ë¯¸ì •ì˜ (ì—ëŸ¬) =====
return FailureAndDiscard($"ë¯¸ì •ì˜: Kai={kaiState}, Insung={insungState}");
```

---

## ğŸ—ï¸ ê³¨ê²© í•¨ìˆ˜ (3ê°œë§Œ)

### 1. CheckIsOrderAsync_KaiSameInsungIfChanged (ë©”ì¸)
```csharp
public async Task<CommonResult_AutoAllocProcess> CheckIsOrderAsync_KaiSameInsungIfChanged(
    AutoAllocModel item,
    CommonResult_AutoAllocDatagrid dgInfo,
    CancelTokenControl ctrl)
{
    // ìœ„ì˜ 5ê°€ì§€ ë¶„ê¸° ë¡œì§ êµ¬í˜„
    // TODOëŠ” ìµœì†Œí™”
}
```

### 2. UpdateKaiStateAsync (í—¬í¼)
```csharp
private async Task<bool> UpdateKaiStateAsync(AutoAllocModel item, string newState)
{
    StdResult_Int result = await CommonVars.s_SrGClient.SrResult_OnlyOrderState_UpdateRowAsync_Today(
        item.NewOrder,
        newState
    );

    if (result.nResult > 0)
    {
        Debug.WriteLine($"  â†’ Kai DB ì—…ë°ì´íŠ¸ ì„±ê³µ: {item.NewOrder.OrderState} â†’ {newState}");
        return true;
    }
    else
    {
        Debug.WriteLine($"  â†’ Kai DB ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: {result.sErrNPos}");
        return false;
    }
}
```

### 3. CancelOtherAppsAsync (ìŠ¤í…)
```csharp
private async Task CancelOtherAppsAsync(AutoAllocModel item, CancelTokenControl ctrl)
{
    Debug.WriteLine($"[CancelOtherAppsAsync] ë‹¤ë¥¸ ì•± ì·¨ì†Œ ì‹œì‘: KeyCode={item.KeyCode}");

    // TODO: Insung2 ì·¨ì†Œ
    if (!string.IsNullOrEmpty(item.NewOrder.Insung2))
    {
        Debug.WriteLine($"  - Insung2 ì·¨ì†Œ: {item.NewOrder.Insung2} [TODO]");
    }

    // TODO: í™”ë¬¼24ì‹œ ì·¨ì†Œ
    if (!string.IsNullOrEmpty(item.NewOrder.Hwamul24))
    {
        Debug.WriteLine($"  - í™”ë¬¼24ì‹œ ì·¨ì†Œ: {item.NewOrder.Hwamul24} [TODO]");
    }

    // TODO: ì›ì½œ ì·¨ì†Œ
    if (!string.IsNullOrEmpty(item.NewOrder.OneCall))
    {
        Debug.WriteLine($"  - ì›ì½œ ì·¨ì†Œ: {item.NewOrder.OneCall} [TODO]");
    }

    Debug.WriteLine($"[CancelOtherAppsAsync] ë‹¤ë¥¸ ì•± ì·¨ì†Œ ì™„ë£Œ (ìŠ¤í…)");
}
```

---

## ğŸ“‹ êµ¬í˜„ ìˆœì„œ (ë‹¨ê³„ë³„)

### Phase 1: ê³¨ê²© êµ¬í˜„ (ì˜¤ëŠ˜!) âš ï¸
**ëª©í‘œ**: ë¶„ê¸° ë¡œì§ë§Œ ë™ì‘í•˜ê²Œ

1. **InsungsAct_RcptRegPage.cs**ì— í•¨ìˆ˜ ì¶”ê°€
   - `CheckIsOrderAsync_KaiSameInsungIfChanged` (5ê°€ì§€ ë¶„ê¸°ë§Œ)
   - `UpdateKaiStateAsync` (í—¬í¼)
   - `CancelOtherAppsAsync` (ìŠ¤í…, TODOë§Œ)

2. **NwInsung01.cs** Line 577 ì£¼ì„ í•´ì œ
   ```csharp
   resultAuto = await m_Context.RcptRegPageAct.CheckIsOrderAsync_KaiSameInsungIfChanged(
       foundItem, dgInfoNotChanged, ctrl);
   ```

3. **ë¹Œë“œ ë° ê¸°ë³¸ í…ŒìŠ¤íŠ¸**
   - ì»´íŒŒì¼ ì—ëŸ¬ ì—†ì´ ë¹Œë“œ
   - ë¡œê·¸ ì¶œë ¥ í™•ì¸ (ë¶„ê¸° ì§„ì… í™•ì¸)

---

### Phase 2: ì‹¤ì œ ë™ì‘ í…ŒìŠ¤íŠ¸ (ë‹¤ìŒ ë‹¨ê³„)
**ëª©í‘œ**: ê° ë¶„ê¸°ê°€ ì‹¤ì œë¡œ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸

1. ë¶„ê¸° 1 í…ŒìŠ¤íŠ¸: Kai ì ‘ìˆ˜ + Insung ì ‘ìˆ˜/ë°°ì°¨
   - ë¡œê·¸: "ì ‘ìˆ˜ ìœ ì§€, ëª¨ë‹ˆí„°ë§ ê³„ì†"

2. ë¶„ê¸° 2 í…ŒìŠ¤íŠ¸: 40ì´ˆ íƒ€ì´ë¨¸
   - ë¡œê·¸: "ìš´í–‰ ì§„ì… - íƒ€ì´ë¨¸ ì‹œì‘"
   - ë¡œê·¸: "ìš´í–‰ ì¤‘ - ê²½ê³¼ ì‹œê°„: Xì´ˆ"
   - ë¡œê·¸: "40ì´ˆ ê²½ê³¼! Kai DB ì—…ë°ì´íŠ¸"

3. ë¶„ê¸° 3/4/5 í…ŒìŠ¤íŠ¸

---

### Phase 3: TODO ì±„ì›Œë‚˜ê°€ê¸° (ì‹œí–‰ì°©ì˜¤)
**ì‹¤ì œ í™˜ê²½ì—ì„œ ë°œê²¬ë˜ëŠ” ë¬¸ì œë“¤ì„ í•˜ë‚˜ì”© í•´ê²°**

1. **CancelOtherAppsAsync êµ¬í˜„**
   - Insung2 ì·¨ì†Œ ë¡œì§
   - í™”ë¬¼24ì‹œ ì·¨ì†Œ ë¡œì§
   - ì›ì½œ ì·¨ì†Œ ë¡œì§

2. **ì¶©ëŒ ê°ì§€ ì¶”ê°€** (ë¶„ê¸° 2ì— ì¶”ê°€)
   ```csharp
   if (elapsed.TotalSeconds >= 40)
   {
       // TODO: ë‹¤ë¥¸ ì•± ìƒíƒœ ì²´í¬
       // TODO: ì¶©ëŒ ìˆìœ¼ë©´ ìˆ˜ë™ ì„ íƒ
       // TODO: ì¶©ëŒ ì—†ìœ¼ë©´ ìë™ ì·¨ì†Œ
   }
   ```

3. **ì˜ˆì™¸ ì²˜ë¦¬**
   - DB ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„
   - íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬
   - ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì²˜ë¦¬

---

### Phase 4: ê³ ê¸‰ ê¸°ëŠ¥ (ë‚˜ì¤‘ì—)
**ì¶©ëŒ ì²˜ë¦¬, ìˆ˜ë™ ì„ íƒ ë“±**

1. GetOtherAppStatesAsync êµ¬í˜„
2. ManualSelectionDialog WPF ëŒ€í™”ìƒì
3. ShowManualSelectionDialogAsync êµ¬í˜„
4. CancelUnselectedAppsAsync êµ¬í˜„

---

## ğŸ“ êµ¬í˜„ ì‹œ ì£¼ì˜ì‚¬í•­

### âœ… DO (í•´ì•¼ í•  ê²ƒ)
- **ë¶„ê¸° ë¡œì§ë§Œ ëª…í™•íˆ êµ¬í˜„** (if-else)
- **ë¡œê·¸ ë§ì´ ì°ê¸°** (Debug.WriteLine)
- **TODO ì£¼ì„ ë§ì´ ë‚¨ê¸°ê¸°**
- **ì‹¤ì œ ë™ì‘í•˜ë©´ì„œ ì±„ì›Œë‚˜ê°€ê¸°**

### âŒ DON'T (í•˜ì§€ ë§ ê²ƒ)
- ëª¨ë“  ì˜ˆì™¸ ìƒí™©ì„ ë¯¸ë¦¬ ì²˜ë¦¬í•˜ë ¤ê³  í•˜ì§€ ë§ê¸°
- ì™„ë²½í•˜ê²Œ ë§Œë“¤ë ¤ê³  í•˜ì§€ ë§ê¸°
- ì¶©ëŒ ì²˜ë¦¬ë¥¼ ì²˜ìŒë¶€í„° êµ¬í˜„í•˜ì§€ ë§ê¸° (Phase 3ì—ì„œ)
- ë³µì¡í•œ êµ¬ì¡° ë§Œë“¤ì§€ ë§ê¸°

---

## ğŸ¯ Phase 1 êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] `CheckIsOrderAsync_KaiSameInsungIfChanged` í•¨ìˆ˜ ì‘ì„± (5ê°€ì§€ ë¶„ê¸°)
- [ ] `UpdateKaiStateAsync` í—¬í¼ í•¨ìˆ˜ ì‘ì„±
- [ ] `CancelOtherAppsAsync` ìŠ¤í… í•¨ìˆ˜ ì‘ì„±
- [ ] `NwInsung01.cs` Line 577 ì£¼ì„ í•´ì œ
- [ ] ë¹Œë“œ ì„±ê³µ í™•ì¸
- [ ] ë¡œê·¸ ì¶œë ¥ í™•ì¸ (ì–´ë–¤ ë¶„ê¸°ë¡œ ë“¤ì–´ê°€ëŠ”ì§€)

---

## ğŸ“Š ì˜ˆìƒ ë¡œê·¸ (Phase 1)

```
[CheckIsOrderAsync_KaiSameInsungIfChanged]
  KeyCode: 12345
  Kai ìƒíƒœ: ì ‘ìˆ˜, Insung ìƒíƒœ: ë°°ì°¨
  â†’ ë¶„ê¸° 1: ì ‘ìˆ˜ ìœ ì§€

[CheckIsOrderAsync_KaiSameInsungIfChanged]
  KeyCode: 12345
  Kai ìƒíƒœ: ì ‘ìˆ˜, Insung ìƒíƒœ: ìš´í–‰
  â†’ ë¶„ê¸° 2-1: ìš´í–‰ ì§„ì… - íƒ€ì´ë¨¸ ì‹œì‘

[CheckIsOrderAsync_KaiSameInsungIfChanged]
  KeyCode: 12345
  Kai ìƒíƒœ: ì ‘ìˆ˜, Insung ìƒíƒœ: ìš´í–‰
  â†’ ë¶„ê¸° 2-2: ìš´í–‰ ì¤‘ - ê²½ê³¼ ì‹œê°„: 42.3ì´ˆ
  â†’ 40ì´ˆ ê²½ê³¼! Kai DB ì—…ë°ì´íŠ¸ ì‹œì‘
  â†’ Kai DB ì—…ë°ì´íŠ¸ ì„±ê³µ: ì ‘ìˆ˜ â†’ ë°°ì°¨
[CancelOtherAppsAsync] ë‹¤ë¥¸ ì•± ì·¨ì†Œ ì‹œì‘
  - Insung2 ì·¨ì†Œ: IS2-12345 [TODO]
  - í™”ë¬¼24ì‹œ ì·¨ì†Œ: HW-12345 [TODO]
[CancelOtherAppsAsync] ë‹¤ë¥¸ ì•± ì·¨ì†Œ ì™„ë£Œ (ìŠ¤í…)
```

---

**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-11-07
