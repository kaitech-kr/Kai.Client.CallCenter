# 작업 가이드

## 📋 완료된 작업

### 1. 접수등록 - 요금 및 오더메모 입력 (2025-10-29)
**파일**: `InsungsAct_RcptRegPage.cs`

**구현 내용**:
- 요금 입력 (기본요금, 추가금액, 할인금액, 탁송료)
  - 보안상 키보드 시뮬레이션만 사용 (SetWindowText 불가)
  - `ResgistAndVerify요금Async` 함수로 입력 및 검증
- 오더메모 입력 (형식: `{KeyCode}/{OrderMemo}`)
  - `WriteAndVerifyEditBoxAsync` 사용

**핵심 함수**:
- `ResgistAndVerify요금Async` (Line 3739-3765): 요금 필드 입력/검증, 3회 재시도
- `WriteAndVerifyEditBoxAsync` (Line 3011-3071): EditBox 입력/검증

### 2. 접수등록 - 첫 로우 선택 검증 (2025-10-30)
**파일**: `InsungsAct_RcptRegPage.cs`

**구현 내용**:
- 첫 로우 선택 검증 (중심 라인 평균 밝기 방식)
  - 선택 시 반전되어 어두워짐 → `평균 밝기 < 배경 밝기 - 10`
- 첫 로우 클릭 함수 개선 (클릭 후 검증 및 재시도)

**핵심 함수**:
- `VerifyFirstRowSelectedAsync` (Line 2541-2603): 중심 라인 평균 밝기로 선택 검증
- `ClickFirstRowAsync` (Line 2482-2539): 클릭 후 검증, 실패 시 재시도

### 3. Datagrid 배경 밝기 측정 및 Region 5-1, 5-3 개선 (2025-11-02)
**파일**:
- `InsungsAct_RcptRegPage.cs`
- `NwInsung01.cs`

**구현 내용**:
1. **배경 밝기 측정 위치 수정**
   - Empty Row의 샘플 포인트를 (3,3)에서 (8,8)로 변경
   - 측정값이 211에서 255로 개선되어 정확도 향상
   - `InsungsAct_RcptRegPage.cs` Line 832

2. **Region 5-1: 총계 읽기 로직 개선**
   - 한 번만 시도하던 로직을 백업 코드처럼 반복 구조로 변경
   - 조회버튼 클릭과 총계 읽기를 `c_nRepeatNormal`회 반복
   - 실패 시 `c_nWaitNormal` 대기 후 재시도
   - `NwInsung01.cs` Line 376-400

3. **Region 5-3: 유효 로우 체크 로직 완성**
   - 페이지별 유효 로우 갯수 측정 구현
   - 밝기 측정 위치: `rects[0, y].Right, rects[0, y].Top + 6`
   - 임계값: `배경 밝기 - 1`
   - 밝기가 임계값 미만이면 유효 로우로 카운트
   - `NwInsung01.cs` Line 465-479

**핵심 로직**:
```csharp
// Region 5-1: 총계 읽기 재시도
for (int i = 0; i < c_nRepeatNormal; i++)
{
    StdResult_Status resultQuery = await Click조회버튼Async(ctrl);
    if (resultQuery.Result == StdResult.Fail) continue;

    sThisTotCount = GetWindowCaption(CallCount_hWnd총계);
    if (!string.IsNullOrEmpty(sThisTotCount)) break;

    await Task.Delay(c_nWaitNormal, ctrl.Token);
}

// Region 5-3: 유효 로우 체크
int nThreshold = nBackgroundBright - 1;
for (int y = 2; y < rects.GetLength(1); y++)
{
    Draw.Point ptCheck = new Draw.Point(rects[0, y].Right, rects[0, y].Top + 6);
    int nCurBright = OfrService.GetPixelBrightness(bmpDG, ptCheck);

    if (nCurBright < nThreshold)
        nValidRows++;
    else
        break;
}
```

---

## 🔧 진행 중 작업

### 1. RightSliding 재귀 로직 개선
**목적**: "123456789"처럼 많은 문자가 붙어있을 때 재귀 처리

**현재 문제**:
- RightSliding 2단계에서 나머지 영역 통째로 DB 검색
- 여러 문자 붙어있으면 실패 → "☒9" 부분 실패 결과

**해결 방안**: 가로/세로 비율 기준 (1.25배)
```csharp
if (width <= height * 1.25)
{
    // 단일 문자 가능성 → 전경/배경 방식 먼저 시도
    // 실패 시 → 재귀 RightSliding
}
else
{
    // 여러 문자 확실 → 바로 재귀 RightSliding
}
```

**수정 위치**:
- 파일: `Ofr_CharSet_Core.cs`
- 함수: `RecognizeCharSetAsync_RightSliding`
- Line: 584-655 (2단계 부분)

### 2. Region 5-3 - 기존 주문 처리
**목표**: 페이지별로 순회하며 리스트 전체 검사

**완료 상태**:
- ✅ 페이지별 리스트 검사 루프 구조 (NwInsung01.cs Line 407-461)
- ✅ 타입 변경 (AutoAlloc → AutoAllocModel 등)
- ✅ 빌드 성공 (커밋 f99e928)

**남은 작업**:

**우선순위 1: OFR 메서드 구현**
- [ ] Datagrid 주문번호 읽기 메서드
- [ ] Datagrid 상태 읽기 메서드
- 참고: InsungsAct_RcptRegPage.cs Line 2663 `GetFirstRowSeqnoAsync`

**우선순위 2: 페이지 이동 구현** (Line 412-415)
- [ ] PageDown 키 또는 스크롤 구현
- [ ] 페이지 이동 후 대기 로직
- [ ] 페이지 이동 확인

**우선순위 3: 주문번호 찾기 루프** (Line 417, 429-432)
```csharp
// 현재 페이지 캡처 → 행별 주문번호 읽기 → 찾으면 행 인덱스 저장
for (int rowIdx = 2; rowIdx < nRowsPerPage + 2; rowIdx++)
{
    string sPageSeqno = OFR로_주문번호_읽기(bmpPage, rowIdx);
    if (sPageSeqno == sSeqNo) { /* 찾음 */ }
}
```

**우선순위 4: StateFlag 처리** (Line 438-449)
- [ ] CheckIsOrderAsync_KaiSameInsungIfChanged 구현
- [ ] Command_ChaneTo취소AndDoDelete 구현
- [ ] CheckIsOrderAsync_AssumeKaiUpdated 구현
- [ ] 재적재 로직 구현

**핵심 알고리즘**:
```csharp
// 페이지별 순회
for (int pageIdx = 1; pageIdx <= nTotPage; pageIdx++)
{
    // 1. 페이지 이동
    // 2. 페이지 캡처

    // 리스트 전체 검사 (역순 - 삭제 안전)
    for (int no = listEtcGroup.Count; no > 0; no--)
    {
        // 3. 현재 페이지에서 주문번호 찾기
        // 4. 찾으면 OFR로 상태 읽기
        // 5. StateFlag별 처리
        // 6. 재적재 또는 삭제
        listEtcGroup.RemoveAt(index);
    }

    // 7. 조기 탈출
    if (listEtcGroup.Count == 0) break;
}
```

---

## 📌 주요 상수 및 참고

### Datagrid 컬럼 (InsungsAct_RcptRegPage.cs Line 88-90)
- `c_nCol상태 = 1`
- `c_nCol주문번호 = 2`

### Datagrid 구조
- y=0: 헤더
- y=1: 빈 행 (Empty Row)
- y=2~: 데이터 행

### 대기 시간
- `c_nWaitShort`: 짧은 대기
- `c_nWaitNormal`: 보통 대기
- `c_nWaitLong = 250ms`: 긴 대기

### 재시도 횟수
- `c_nRepeatShort = 3`: 3회 재시도

---

## 🔗 최근 커밋

- `f78e473` - feat: ReEnqueue 함수 개선 및 Skip case 처리 추가
- `f99e928` - feat: Region 5-3 페이지별 검색 루프 구조 구현
- `40a2161` - feat: Region 5-1, 5-2 구현 (기존 주문 관리)
- `caad2f6` - feat: SignalR로 Kai DB Insung1 업데이트 구현

---

**최종 업데이트**: 2025-11-02
