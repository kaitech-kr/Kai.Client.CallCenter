# 작업 내역: 접수등록 첫 로우 선택 검증 구현

**작업 일자**: 2025-10-30
**작업 파일**: `Kai.Client.CallCenter/Networks/NwInsungs/InsungsAct_RcptRegPage.cs`

## 1. 구현 완료 기능

### 1.1 첫 로우 선택 검증 함수 (Line 2541-2603)

**함수명**: `VerifyFirstRowSelectedAsync`

**목적**: 첫 번째 데이터 로우가 선택되었는지 중심 라인 평균 밝기로 검증

**검증 방식**:
- 중심 라인의 평균 밝기 측정 (라인 전체, 높이 1픽셀)
- 배경 밝기와 비교
- 선택 시 반전되어 어두워지므로: `평균 밝기 < 배경 밝기 - threshold`

**주요 로직**:
```csharp
// 1. DG 캡처
Draw.Bitmap bmpDG = OfrService.CaptureScreenRect_InWndHandle(m_RcptPage.DG오더_hWnd);

// 2. 첫 데이터 행 [0, 2]의 Rectangle 가져오기
Draw.Rectangle rectRow = m_RcptPage.DG오더_RelChildRects[0, 2];

// 3. 중심 라인의 Rectangle 생성 (높이 1픽셀)
int centerY = rectRow.Top + rectRow.Height / 2;
Draw.Rectangle rcCenterLine = new Draw.Rectangle(
    rectRow.Left,
    centerY,
    rectRow.Width,
    1  // 높이 1픽셀
);

// 4. 중심 라인의 평균 밝기 계산
byte avgBrightness = OfrService.GetAverageBrightness_FromColorBitmapRectFast(
    bmpDG,
    rcCenterLine,
    1.0  // weight: 보정 없이 순수 평균
);

// 5. 배경 밝기와 비교
int threshold = 10;
bool isSelected = avgBrightness < (m_RcptPage.DG오더_nBackgroundBright - threshold);
```

**사용된 기존 함수**:
- `OfrService.CaptureScreenRect_InWndHandle`: DG 캡처
- `OfrService.GetAverageBrightness_FromColorBitmapRectFast`: 영역 평균 밝기 계산 (Unsafe 최적화)

### 1.2 첫 로우 클릭 함수 개선 (Line 2482-2539)

**함수명**: `ClickFirstRowAsync` (기존 함수 개선)

**개선 내용**:
1. `retryCount` 파라미터 추가 (기본값 3)
2. 클릭 후 `VerifyFirstRowSelectedAsync` 호출하여 검증
3. 검증 실패 시 자동 재시도
4. 상세 로그 출력 (시도 횟수, 검증 결과)

**재시도 로직**:
```csharp
for (int i = 1; i <= retryCount; i++)
{
    // 클릭
    await Std32Mouse_Post.MousePostAsync_ClickLeft_ptRel(m_RcptPage.DG오더_hWnd, ptRel);
    await Task.Delay(CommonVars.c_nWaitNormal, ctrl.Token);

    // 선택 검증
    bool isSelected = await VerifyFirstRowSelectedAsync(ctrl);

    if (isSelected)
    {
        return true;  // 성공
    }

    if (i < retryCount)
    {
        await Task.Delay(200, ctrl.Token);  // 재시도 전 대기
    }
}
```

## 2. 기술적 결정 사항

### 2.1 왜 중심 라인 평균 밝기인가?

**고려한 방법들**:
1. ❌ 여백 vs 텍스트 영역 비교: 텍스트 위치 특정 어려움
2. ❌ 첫 로우 vs 둘째 로우 비교: 둘째 로우도 선택될 수 있음
3. ✅ **중심 라인 평균 밝기**: 안정적이고 간단

**선택 이유**:
- 여백/텍스트 구분 불필요 (라인 전체 평균)
- 단일 픽셀보다 안정적 (노이즈에 강함)
- 선택 반전 시 전체가 어두워지므로 평균도 낮아짐
- 기존 함수 활용 가능

### 2.2 라인의 높이 1픽셀 선택

**이유**:
- `GetAverageBrightness_FromColorBitmapRectFast`는 Rectangle 영역의 모든 픽셀 평균 계산
- 높이 1픽셀 = 수평 라인 = 가로 방향 전체의 평균
- 효율적이고 대표성 있는 샘플

### 2.3 Threshold = 10

**기준**:
- 주석으로 남아있던 테스트 코드 (Line 3641) 참고
- 밝기 차이 임계값 10: 충분히 명확한 구분
- 추후 테스트를 통해 조정 가능

## 3. 디버그 로그 출력

### 3.1 VerifyFirstRowSelectedAsync
```
[AppName] ===== 첫 로우 선택 검증 =====
[AppName] 배경 밝기: {배경값}
[AppName] 중심 라인 평균: {측정값}
[AppName] 차이: {배경값 - 측정값}
[AppName] 선택 여부: {선택됨/선택 안됨}
```

### 3.2 ClickFirstRowAsync
```
[AppName] ===== 첫 로우 클릭 시도 {i}/{retryCount} =====
[AppName] DG 기준 Rect: (Left,Top,Right,Bottom)
[AppName] 클릭 포인트: (X,Y)
[AppName] 첫 로우 클릭 완료, 검증 시작
[AppName] 첫 로우 선택 검증 성공/실패 (시도 {i}/{retryCount})
```

## 4. 준수한 기본수칙

### Rule 7: 함수 선언 수평 작성
```csharp
// ✅ 올바른 예
private async Task<bool> VerifyFirstRowSelectedAsync(CancelTokenControl ctrl)
private async Task<bool> ClickFirstRowAsync(CancelTokenControl ctrl, int retryCount = 3)
```

## 5. 다음 작업 예정

### 5.1 현재 완료 상태
- ✅ 조회 버튼 클릭
- ✅ 첫 로우 클릭
- ✅ 첫 로우 선택 검증

### 5.2 다음 구현 대상
1. **Datagrid 캡처** (첫 로우)
2. **Seqno 추출** (OFR)
3. **item.NewOrder.Insung1/2 업데이트**
4. **SignalR Kai DB 업데이트**
5. 전체 자동배차 루프 통합

## 6. 참고사항

### 6.1 배경 밝기 저장 위치
- `InsungsAct_RcptRegPage.cs` Line 819-822
- `m_RcptPage.DG오더_nBackgroundBright`
- SetDG오더RectsAsync에서 Empty Row의 샘플 포인트로 측정

### 6.2 선택 반전 원리
- 정상 상태: 배경(밝음) > 텍스트(어두움)
- 선택 상태: 배경(어두움) < 텍스트(밝음) ← 반전!
- 중심 라인 평균: 선택 시 전체가 어두워지므로 평균 ↓

### 6.3 OfrService 함수
- `GetAverageBrightness_FromColorBitmapRectFast`: Line 1385-1438
- Unsafe 코드로 최적화됨
- weight 파라미터: 1.0 = 보정 없이 순수 평균

### 6.4 좌표계 (이전 작업에서 수정됨)
- RelChildRects: DG 기준 좌표로 저장
- DG오더_hWnd와 함께 사용 시 직접 사용 가능
- 좌표 변환 불필요

## 7. 빌드 상태

### 7.1 InsungsAct_RcptRegPage.cs
✅ **문법 오류 없음**: 코드 문법 정상

### 7.2 전체 빌드
❌ **Kai.Common.FrmDll_FormCtrl 의존성 에러**:
- Error MSB3823, MSB3822: System.Resources.Extensions 관련
- 이 에러는 InsungsAct_RcptRegPage.cs와 무관
- 의존성 프로젝트 리소스 문제

**참고**: 코드 수정은 완료되었으며, 의존성 프로젝트 문제 해결 필요

## 8. 커밋 정보

**커밋 메시지**: feat: 접수등록 첫 로우 선택 검증 기능 구현

**변경 파일**:
- `Kai.Client.CallCenter/Networks/NwInsungs/InsungsAct_RcptRegPage.cs`

**변경 내용**:
1. VerifyFirstRowSelectedAsync 함수 추가 (Line 2541-2603)
2. ClickFirstRowAsync 함수 개선 - 검증 및 재시도 로직 추가 (Line 2482-2539)
