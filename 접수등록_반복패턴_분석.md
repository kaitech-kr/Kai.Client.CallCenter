# 접수등록 반복 패턴 분석

**작성일**: 2025-10-25
**분석 대상**: `Backup/Networks/NwInsungs/InsungsAct_ReceiptPage.cs`
**목적**: 신규 등록/수정 로직의 공통 패턴 추출 및 함수화 설계

---

## 1. 전체 구조 (접수Wnd_RegistOrderAsync 기준)

```
┌─────────────────────────────────────────┐
│ 1. 윈도우 캡처 및 핸들 초기화           │
│    - OfrService.CaptureScreenRect       │
│    - wndRcpt.SetWndHandles              │
└─────────────────────────────────────────┘
           ↓
┌─────────────────────────────────────────┐
│ 2. 의뢰자 정보 입력                      │
│    - 고객명 → 고객 검색                  │
│    - 전화1, 전화2                        │
│    - 부서, 담당                          │
└─────────────────────────────────────────┘
           ↓
┌─────────────────────────────────────────┐
│ 3. 출발지 정보 입력                      │
│    - 의뢰자와 같은지 체크                │
│    - 고객명 → 고객 검색                  │
│    - 동명, 전화1, 전화2                  │
│    - 부서, 담당, 위치                    │
└─────────────────────────────────────────┘
           ↓
┌─────────────────────────────────────────┐
│ 4. 도착지 정보 입력                      │
│    - 의뢰자와 같은지 체크                │
│    - 고객명 → 고객 검색                  │
│    - 동명, 전화1, 전화2                  │
│    - 부서, 담당, 위치, 적요              │
└─────────────────────────────────────────┘
           ↓
┌─────────────────────────────────────────┐
│ 5. 기타 정보 입력                        │
│    - 공유 (CheckBox)                     │
│    - 요금종류 (RadioButton Group)        │
│    - 차량종류 (RadioButton Group)        │
│    - 차량톤수 (ComboBox, 트럭인 경우)    │
│    - 트럭상세 (ComboBox, 트럭인 경우)    │
└─────────────────────────────────────────┘
           ↓
┌─────────────────────────────────────────┐
│ 6. 저장 및 확인                          │
│    - 주문상태별 버튼 클릭                │
│      "접수" → Btn_hWnd접수저장          │
│      "대기" → Btn_hWnd대기저장          │
│    - Click조회버튼Async (확인)          │
│    - ClickEmptyRowAsync (선택 해제)     │
└─────────────────────────────────────────┘
```

---

## 2. 반복 패턴 #1: EditBox 입력 (재시도 포함)

### 패턴 코드:
```csharp
// 전화1 입력 예시
if (tbOrder.CallTelNo != (sTmp = StdConvert.MakePhoneNumberToDigit(Std32Window.GetWindowCaption(wndRcpt.의뢰자_hWnd전화1))))
{
    for (int i = 0; i < c_nRepeatShort; i++)
    {
        await OfrWork_Common.WriteEditBox_ToHndleAsync_WithEnterKeyWait(wndRcpt.의뢰자_hWnd전화1, tbOrder.CallTelNo);
        if (tbOrder.CallTelNo == (sTmp = StdConvert.MakePhoneNumberToDigit(Std32Window.GetWindowCaption(wndRcpt.의뢰자_hWnd전화1))))
            break;

        await Task.Delay(c_nWaitNormal);
    }

    if (tbOrder.CallTelNo != sTmp)
        return LocalCommon_StdResult.ErrMsgResult_NulBool($"전화1 입력실패: {tbOrder.CallTelNo} <=> {sTmp}", "...");
}
```

### 반복 요소:
1. **현재 값 읽기** → `Std32Window.GetWindowCaption(hWnd)`
2. **값 비교** → 다르면 입력, 같으면 스킵
3. **재시도 루프** (c_nRepeatShort = 3회)
   - WriteEditBox
   - 검증 (값 다시 읽기)
   - break or Delay
4. **최종 검증** → 실패 시 에러 반환

### 공통 함수 제안:

```csharp
/// <summary>
/// EditBox에 값을 입력하고 검증 (재시도 포함)
/// </summary>
private async Task<bool> WriteAndVerifyEditBoxAsync(
    IntPtr hWnd,
    string expectedValue,
    string fieldName,
    Func<string, string> normalizer = null,  // 전화번호 정규화 등
    bool useEnterKey = false)
{
    normalizer = normalizer ?? (s => s);  // 기본값: 그대로 반환

    string currentValue = normalizer(Std32Window.GetWindowCaption(hWnd));
    if (expectedValue == currentValue)
        return true;  // 이미 일치

    // 재시도
    for (int i = 0; i < c_nRepeatShort; i++)
    {
        if (useEnterKey)
            await OfrWork_Common.WriteEditBox_ToHndleAsync_WithEnterKeyWait(hWnd, expectedValue);
        else
            await OfrWork_Common.WriteEditBox_ToHndleAsync(hWnd, expectedValue);

        currentValue = normalizer(Std32Window.GetWindowCaption(hWnd));
        if (expectedValue == currentValue)
            return true;

        await Task.Delay(c_nWaitNormal);
    }

    Debug.WriteLine($"[{fieldName}] 입력 실패: 기대={expectedValue}, 실제={currentValue}");
    return false;
}
```

### 사용 예시:
```csharp
// 전화1 입력
if (!await WriteAndVerifyEditBoxAsync(
    wndRcpt.의뢰자_hWnd전화1,
    tbOrder.CallTelNo,
    "의뢰자 전화1",
    StdConvert.MakePhoneNumberToDigit,  // 정규화 함수
    useEnterKey: true))
{
    return RegistResult.ErrorResult("의뢰자 전화1 입력 실패");
}

// 부서 입력
if (!await WriteAndVerifyEditBoxAsync(
    wndRcpt.의뢰자_hWnd부서,
    tbOrder.CallDeptName,
    "의뢰자 부서",
    useEnterKey: true))
{
    return RegistResult.ErrorResult("의뢰자 부서 입력 실패");
}
```

---

## 3. 반복 패턴 #2: 고객 검색 (의뢰자, 출발지, 도착지 공통)

### 패턴 코드:
```csharp
// 1. 검색어 생성
sSearch = NwCommon.GetInsungTextForSearch(tbOrder.CallCustName, tbOrder.CallChargeName);

// 2. 고객명 EditBox에 입력
resultBool = await OfrWork_Common.WriteEditBox_ToHndleAsync(wndRcpt.의뢰자_hWnd고객명, sSearch);
if (resultBool == null || !resultBool.bResult)
    return Error("텍스트 입력실패");

// 3. 고객 검색 결과 타입 확인
resultSearch = await GetCustSearchTypeAsync(wndRcpt.의뢰자_hWnd고객명, wndRcpt.의뢰자_hWnd동명);
if (resultSearch.resultTye == AutoAlloc_CustSearch.Null)
    return Error("의뢰자 입력실패");

// 4. 결과 타입별 처리
switch (resultSearch.resultTye)
{
    case AutoAlloc_CustSearch.One:  // 단일 고객 → 자동 입력됨
        break;

    case AutoAlloc_CustSearch.Multi:  // 복수 고객 → 고객검색창 처리
        resultError = await 고객검색Wnd_RegistOrderAsync(resultSearch, ctrl);
        // TODO: 현재는 MsgBox + throw
        break;

    case AutoAlloc_CustSearch.None:  // 신규 고객 → 고객등록창 처리
        custRegWnd = new CustRegWnd(resultSearch.hWndResult, fInfo);
        // TODO: 현재는 MsgBox + throw
        break;
}
```

### 반복 요소:
- **의뢰자** 검색: `CallCustName`, `CallChargeName`
- **출발지** 검색: `StartCustName`, `StartChargeName`
- **도착지** 검색: `DestCustName`, `DestChargeName`

### 공통 함수 제안:

```csharp
/// <summary>
/// 고객 검색 및 결과 처리
/// </summary>
private async Task<CustomerResult> SearchAndSelectCustomerAsync(
    IntPtr hWnd고객명,
    IntPtr hWnd동명,
    string custName,
    string chargeName,
    string fieldLabel,  // "의뢰자", "출발지", "도착지"
    CancelTokenControl ctrl)
{
    // 1. 검색어 생성
    string searchText = NwCommon.GetInsungTextForSearch(custName, chargeName);

    // 2. 고객명 입력
    var resultBool = await OfrWork_Common.WriteEditBox_ToHndleAsync(hWnd고객명, searchText);
    if (resultBool == null || !resultBool.bResult)
        return CustomerResult.ErrorResult($"{fieldLabel} 고객명 입력 실패");

    // 3. 검색 결과 타입 확인
    var resultSearch = await GetCustSearchTypeAsync(hWnd고객명, hWnd동명);
    if (resultSearch.resultTye == AutoAlloc_CustSearch.Null)
        return CustomerResult.ErrorResult($"{fieldLabel} 고객 검색 실패");

    // 4. 결과 처리
    switch (resultSearch.resultTye)
    {
        case AutoAlloc_CustSearch.One:
            return CustomerResult.SuccessResult();

        case AutoAlloc_CustSearch.Multi:
            // TODO: 복수 고객 선택 UI 처리
            return CustomerResult.ErrorResult($"{fieldLabel}: 복수 고객 (미구현)");

        case AutoAlloc_CustSearch.None:
            // TODO: 신규 고객 등록 UI 처리
            return CustomerResult.ErrorResult($"{fieldLabel}: 신규 고객 (미구현)");

        default:
            return CustomerResult.ErrorResult($"{fieldLabel}: 알 수 없는 검색 결과");
    }
}
```

### 사용 예시:
```csharp
// 의뢰자 검색
var result = await SearchAndSelectCustomerAsync(
    wndRcpt.의뢰자_hWnd고객명,
    wndRcpt.의뢰자_hWnd동명,
    order.CallCustName,
    order.CallChargeName,
    "의뢰자",
    ctrl);
if (!result.Success)
    return RegistResult.ErrorResult(result.ErrorMessage);

// 출발지 검색 (의뢰자와 다른 경우)
if (order.StartCustCodeK != order.CallCustCodeK)
{
    result = await SearchAndSelectCustomerAsync(
        wndRcpt.출발지_hWnd고객명,
        wndRcpt.출발지_hWnd동명,
        order.StartCustName,
        order.StartChargeName,
        "출발지",
        ctrl);
    if (!result.Success)
        return RegistResult.ErrorResult(result.ErrorMessage);
}
else
{
    // 의뢰자와 같은 경우 → EnterKey로 자동 입력
    await EnterKeyNGet동명Async(wndRcpt.출발지_hWnd고객명, wndRcpt.출발지_hWnd동명);
}
```

---

## 4. 반복 패턴 #3: CheckBox/RadioButton 입력

### 패턴 코드:
```csharp
// CheckBox 예시: 공유
resultNulBool = await OfrWork_Insungs.OfrImgChkValue_RectInBitmapAsync(bmpWnd, fInfo.접수등록Wnd_우측상단_rcChkRel공유);
if (resultNulBool.bResult == null)
    return Error("공유 CheckBox인식 실패");

if (tbOrder.Share != (bTmp = StdConvert.NullableBoolToBool(resultNulBool.bResult)))
{
    for (int i = 0; i < c_nRepeatShort; i++)
    {
        resultError = await this.SetCheckBox_StatusAsync(wndRcpt.TopWnd_hWnd, fInfo.접수등록Wnd_우측상단_rcChkRel공유, tbOrder.Share);
        if (resultError == null) break;
        await Task.Delay(c_nWaitNormal);
    }

    if (resultError != null)
        return Error($"공유체크 입력실패");
}
```

```csharp
// RadioButton Group 예시: 요금종류
resultNulBool = await IsChecked요금종류_InGroupAsync(bmpWnd, wndRcpt.우측상단_btns요금종류, tbOrder.FeeType);
if (resultNulBool.bResult == null)
    return Error("요금 RadioBtn인식 실패");

if (!StdConvert.NullableBoolToBool(resultNulBool.bResult))
{
    for (int i = 0; i < c_nRepeatShort; i++)
    {
        resultError = await this.SetGroupFeeTypeAsync(bmpWnd, wndRcpt.우측상단_btns요금종류, tbOrder.FeeType);
        if (resultError == null) break;
        await Task.Delay(c_nWaitNormal);
    }

    if (resultError != null)
        return Error($"요금체크 입력실패");
}
```

### 반복 요소:
1. **현재 상태 확인** (OFR 이미지 인식)
2. **값 비교** → 다르면 클릭, 같으면 스킵
3. **재시도 루프** (c_nRepeatShort = 3회)
4. **최종 검증** → 실패 시 에러

### 공통 함수 제안:

```csharp
/// <summary>
/// CheckBox 설정 및 검증 (재시도 포함)
/// </summary>
private async Task<bool> SetAndVerifyCheckBoxAsync(
    IntPtr hWndParent,
    Draw.Rectangle rectRel,
    bool expectedValue,
    string fieldName)
{
    // 현재 값 확인 (OFR)
    var bmp = OfrService.CaptureScreenRect_InWndHandle(hWndParent);
    var result = await OfrWork_Insungs.OfrImgChkValue_RectInBitmapAsync(bmp, rectRel);

    if (result.bResult == null)
    {
        Debug.WriteLine($"[{fieldName}] CheckBox 인식 실패");
        return false;
    }

    bool currentValue = StdConvert.NullableBoolToBool(result.bResult);
    if (expectedValue == currentValue)
        return true;  // 이미 일치

    // 재시도
    for (int i = 0; i < c_nRepeatShort; i++)
    {
        var error = await SetCheckBox_StatusAsync(hWndParent, rectRel, expectedValue);
        if (error == null)
            return true;

        await Task.Delay(c_nWaitNormal);
    }

    Debug.WriteLine($"[{fieldName}] CheckBox 설정 실패");
    return false;
}

/// <summary>
/// RadioButton Group 설정 및 검증 (재시도 포함)
/// </summary>
private async Task<bool> SetAndVerifyRadioButtonAsync(
    Draw.Bitmap bmpWnd,
    object buttonGroup,
    string expectedValue,
    string fieldName,
    Func<Draw.Bitmap, object, string, Task<StdResult_NulBool>> checkFunc,
    Func<Draw.Bitmap, object, string, Task<StdResult_Error>> setFunc)
{
    // 현재 값 확인
    var result = await checkFunc(bmpWnd, buttonGroup, expectedValue);
    if (result.bResult == null)
    {
        Debug.WriteLine($"[{fieldName}] RadioButton 인식 실패");
        return false;
    }

    if (StdConvert.NullableBoolToBool(result.bResult))
        return true;  // 이미 선택됨

    // 재시도
    for (int i = 0; i < c_nRepeatShort; i++)
    {
        var error = await setFunc(bmpWnd, buttonGroup, expectedValue);
        if (error == null)
            return true;

        await Task.Delay(c_nWaitNormal);
    }

    Debug.WriteLine($"[{fieldName}] RadioButton 설정 실패");
    return false;
}
```

---

## 5. 반복 패턴 #4: ComboBox 입력 (트럭톤수, 트럭상세)

### 패턴 코드:
```csharp
// 트럭톤수 설정
for (int i = 0; i < 100; i++)
{
    await Task.Delay(c_nWaitVeryShort);
    hWndTmp = Std32Window.GetWndHandle_FromRelDrawPt(wndRcpt.TopWnd_hWnd, fInfo.접수등록Wnd_우측상단_ptChkRel차량톤수Open);

    if (hWndTmp != wndRcpt.우측상단_hWnd플럭제외) // 콤보박스가 열림
    {
        Simulation_Mouse.SafeBlockInputStart();
        break;
    }
}

// 펼쳐졌는지 체크
if (hWndTmp == wndRcpt.우측상단_hWnd플럭제외)
    return Error($"트럭중량 입력실패");

// 인덱스로 항목 선택
int index = Get차량톤수Index(tbOrder.CarWeight);
Std32Mouse_Post.MouseMix_ClickLeft_ptRel(hWndTmp, fInfo.접수등록Wnd_Common_ptComboBox[index]);
Simulation_Mouse.SafeBlockInputStop();
await Task.Delay(100);
```

### 반복 요소:
1. **콤보박스 열림 대기** (특정 hWnd 가려질 때까지)
2. **열림 검증**
3. **값 → 인덱스 변환**
4. **항목 클릭**

### 공통 함수 제안:

```csharp
/// <summary>
/// ComboBox 항목 선택
/// </summary>
private async Task<bool> SelectComboBoxItemAsync(
    IntPtr hWndParent,
    Draw.Point ptCheckOpen,  // 콤보박스 열림 체크 포인트
    IntPtr hWndHiddenWhenOpen,  // 열릴 때 가려지는 윈도우
    int itemIndex,
    string fieldName)
{
    // 1. 콤보박스 열림 대기
    IntPtr hWndCombo = IntPtr.Zero;
    for (int i = 0; i < 100; i++)
    {
        await Task.Delay(c_nWaitVeryShort);
        hWndCombo = Std32Window.GetWndHandle_FromRelDrawPt(hWndParent, ptCheckOpen);

        if (hWndCombo != hWndHiddenWhenOpen)
        {
            Simulation_Mouse.SafeBlockInputStart();
            break;
        }
    }

    // 2. 열림 검증
    if (hWndCombo == hWndHiddenWhenOpen)
    {
        Debug.WriteLine($"[{fieldName}] ComboBox 열림 실패");
        return false;
    }

    try
    {
        // 3. 항목 클릭
        Std32Mouse_Post.MouseMix_ClickLeft_ptRel(
            hWndCombo,
            m_Context.FileInfo.접수등록Wnd_Common_ptComboBox[itemIndex]);
        await Task.Delay(100);
        return true;
    }
    finally
    {
        Simulation_Mouse.SafeBlockInputStop();
    }
}
```

---

## 6. RegistOrderToPopupAsync 구조 제안

```csharp
public async Task<RegistResult> RegistOrderToPopupAsync(
    AutoAlloc item,
    IntPtr hWndPopup,
    CancelTokenControl ctrl)
{
    try
    {
        TbOrder order = item.NewOrder;

        // TODO: RcptWnd_New 클래스로 팝업창 핸들 초기화
        // var wndRcpt = new RcptWnd_New(hWndPopup, m_Context.FileInfo);

        // 1. 의뢰자 정보 입력
        var result = await InputRequesterInfoAsync(order, wndRcpt, ctrl);
        if (!result.Success) return result;

        // 2. 출발지 정보 입력
        result = await InputStartLocationAsync(order, wndRcpt, ctrl);
        if (!result.Success) return result;

        // 3. 도착지 정보 입력
        result = await InputDestLocationAsync(order, wndRcpt, ctrl);
        if (!result.Success) return result;

        // 4. 기타 정보 입력
        result = await InputOtherInfoAsync(order, wndRcpt, ctrl);
        if (!result.Success) return result;

        // 5. 저장
        result = await SaveOrderAsync(order, wndRcpt, ctrl);
        if (!result.Success) return result;

        return RegistResult.SuccessResult();
    }
    catch (Exception ex)
    {
        Debug.WriteLine($"[{m_Context.AppName}] RegistOrderToPopupAsync 예외: {ex.Message}");
        return RegistResult.ErrorResult($"주문 등록 예외: {ex.Message}");
    }
}

/// <summary>
/// 1. 의뢰자 정보 입력
/// </summary>
private async Task<RegistResult> InputRequesterInfoAsync(
    TbOrder order,
    RcptWnd_New wndRcpt,
    CancelTokenControl ctrl)
{
    // 1-1. 고객 검색
    var custResult = await SearchAndSelectCustomerAsync(
        wndRcpt.의뢰자_hWnd고객명, wndRcpt.의뢰자_hWnd동명,
        order.CallCustName, order.CallChargeName,
        "의뢰자", ctrl);
    if (!custResult.Success)
        return RegistResult.ErrorResult(custResult.ErrorMessage);

    // 1-2. 전화1
    if (!await WriteAndVerifyEditBoxAsync(
        wndRcpt.의뢰자_hWnd전화1, order.CallTelNo, "의뢰자 전화1",
        StdConvert.MakePhoneNumberToDigit, useEnterKey: true))
        return RegistResult.ErrorResult("의뢰자 전화1 입력 실패");

    // 1-3. 전화2
    if (!await WriteAndVerifyEditBoxAsync(
        wndRcpt.의뢰자_hWnd전화2, order.CallTelNo2, "의뢰자 전화2",
        StdConvert.MakePhoneNumberToDigit, useEnterKey: true))
        return RegistResult.ErrorResult("의뢰자 전화2 입력 실패");

    // 1-4. 부서
    if (!await WriteAndVerifyEditBoxAsync(
        wndRcpt.의뢰자_hWnd부서, order.CallDeptName, "의뢰자 부서",
        useEnterKey: true))
        return RegistResult.ErrorResult("의뢰자 부서 입력 실패");

    // 1-5. 담당
    if (!await WriteAndVerifyEditBoxAsync(
        wndRcpt.의뢰자_hWnd담당, order.CallChargeName, "의뢰자 담당",
        useEnterKey: true))
        return RegistResult.ErrorResult("의뢰자 담당 입력 실패");

    return RegistResult.SuccessResult();
}

/// <summary>
/// 2. 출발지 정보 입력
/// </summary>
private async Task<RegistResult> InputStartLocationAsync(
    TbOrder order,
    RcptWnd_New wndRcpt,
    CancelTokenControl ctrl)
{
    // 2-1. 의뢰자와 같은지 체크
    if (order.StartCustCodeK == order.CallCustCodeK)
    {
        // EnterKey로 자동 입력
        string dongName = await EnterKeyNGet동명Async(
            wndRcpt.출발지_hWnd고객명, wndRcpt.출발지_hWnd동명);
        if (string.IsNullOrEmpty(dongName))
            return RegistResult.ErrorResult("출발지 정보 얻기 실패");
    }
    else
    {
        // 2-2. 고객 검색
        var custResult = await SearchAndSelectCustomerAsync(
            wndRcpt.출발지_hWnd고객명, wndRcpt.출발지_hWnd동명,
            order.StartCustName, order.StartChargeName,
            "출발지", ctrl);
        if (!custResult.Success)
            return RegistResult.ErrorResult(custResult.ErrorMessage);
    }

    // 2-3. 동명
    if (!await WriteAndVerifyEditBoxAsync(
        wndRcpt.출발지_hWnd동명, order.StartDongBasic, "출발지 동명"))
        return RegistResult.ErrorResult("출발지 동명 입력 실패");

    // 2-4. 전화1
    if (!await WriteAndVerifyEditBoxAsync(
        wndRcpt.출발지_hWnd전화1, order.StartTelNo, "출발지 전화1",
        StdConvert.MakePhoneNumberToDigit, useEnterKey: true))
        return RegistResult.ErrorResult("출발지 전화1 입력 실패");

    // ... (전화2, 부서, 담당, 위치 동일 패턴)

    return RegistResult.SuccessResult();
}

/// <summary>
/// 3. 도착지 정보 입력
/// </summary>
private async Task<RegistResult> InputDestLocationAsync(
    TbOrder order,
    RcptWnd_New wndRcpt,
    CancelTokenControl ctrl)
{
    // 출발지와 동일한 패턴
    // ...

    return RegistResult.SuccessResult();
}

/// <summary>
/// 4. 기타 정보 입력
/// </summary>
private async Task<RegistResult> InputOtherInfoAsync(
    TbOrder order,
    RcptWnd_New wndRcpt,
    CancelTokenControl ctrl)
{
    // 4-1. 공유 (CheckBox)
    if (!await SetAndVerifyCheckBoxAsync(
        wndRcpt.TopWnd_hWnd,
        m_Context.FileInfo.접수등록Wnd_우측상단_rcChkRel공유,
        order.Share, "공유"))
        return RegistResult.ErrorResult("공유 설정 실패");

    // 4-2. 요금종류 (RadioButton)
    var bmpWnd = OfrService.CaptureScreenRect_InWndHandle(wndRcpt.TopWnd_hWnd);
    if (!await SetAndVerifyRadioButtonAsync(
        bmpWnd, wndRcpt.우측상단_btns요금종류, order.FeeType, "요금종류",
        IsChecked요금종류_InGroupAsync, SetGroupFeeTypeAsync))
        return RegistResult.ErrorResult("요금종류 설정 실패");

    // 4-3. 차량종류 (RadioButton)
    if (!await SetAndVerifyRadioButtonAsync(
        bmpWnd, wndRcpt.우측상단_btns차량종류, order.CarType, "차량종류",
        IsChecked차량종류_InGroupAsync, SetGroupCarTypeAsync))
        return RegistResult.ErrorResult("차량종류 설정 실패");

    // 4-4. 트럭인 경우 - 톤수, 상세
    if (order.CarType == "트럭")
    {
        int index = Get차량톤수Index(order.CarWeight);
        if (!await SelectComboBoxItemAsync(
            wndRcpt.TopWnd_hWnd,
            m_Context.FileInfo.접수등록Wnd_우측상단_ptChkRel차량톤수Open,
            wndRcpt.우측상단_hWnd플럭제외,
            index, "차량톤수"))
            return RegistResult.ErrorResult("차량톤수 설정 실패");

        index = Get트럭상세Index(order.TruckDetail);
        if (!await SelectComboBoxItemAsync(
            wndRcpt.TopWnd_hWnd,
            m_Context.FileInfo.접수등록Wnd_우측상단_ptChkRel트럭상세Open,
            wndRcpt.우측상단_hWnd인수증필,
            index, "트럭상세"))
            return RegistResult.ErrorResult("트럭상세 설정 실패");
    }

    return RegistResult.SuccessResult();
}

/// <summary>
/// 5. 저장 및 확인
/// </summary>
private async Task<RegistResult> SaveOrderAsync(
    TbOrder order,
    RcptWnd_New wndRcpt,
    CancelTokenControl ctrl)
{
    // 5-1. 주문 상태에 따라 저장 버튼 선택
    IntPtr hWndSaveBtn = order.OrderState == "접수"
        ? wndRcpt.Btn_hWnd접수저장
        : wndRcpt.Btn_hWnd대기저장;

    // 5-2. 저장 버튼 클릭 및 창 닫힘 대기
    bool bClosed = await ClickNWaitWindowChangedAsync(hWndSaveBtn, wndRcpt.TopWnd_hWnd);
    if (!bClosed)
        return RegistResult.ErrorResult("저장 후 창 닫기 실패");

    // 5-3. 조회 버튼 클릭 (저장 확인)
    // TODO: Click조회버튼Async 주석 해제 후 구현
    // var resultStr = await Click조회버튼Async(ctrl);
    // if (resultStr == null || resultStr.strResult == null)
    //     return RegistResult.ErrorResult("저장 확인 실패");

    // 5-4. Empty Row 클릭 (선택 해제)
    // TODO: ClickEmptyRowAsync 주석 해제 후 구현
    // bool bClicked = await ClickEmptyRowAsync(ctrl);

    return RegistResult.SuccessResult();
}
```

---

## 7. 등록 vs 수정 비교 분석

### 7.1 핵심 차이점

#### 공통점 (95% 동일):
- 입력 로직, 검증 로직, 재시도 패턴 모두 동일
- 의뢰자/출발지/도착지 처리 흐름 동일
- CheckBox/RadioButton/ComboBox 설정 방식 동일

#### 차이점 (5% 차이):

| 구분 | 등록 (RegistOrderAsync) | 수정 (UpdateOrderAsync) |
|------|------------------------|------------------------|
| **팝업창 열기** | 신규등록 버튼 클릭 | Datagrid 행 더블클릭 |
| **Window 클래스** | `RcptWnd_New` | `RcptWnd_Edit` |
| **입력 전략** | **무조건 모두 입력** | **변경된 항목만 입력** |
| **nChanged 변수** | ❌ 사용 안함 | ✅ 변경 추적용 |
| **저장 버튼** | 주문상태별 (접수저장/대기저장) | 수정저장 |

### 7.2 수정 모드의 특별한 로직

#### nChanged 변수 (변경 추적):
```csharp
int nChanged = 0;  // 0=변경없음, 1=고객명 변경, 3=일반필드 변경

// 예시 1: 고객명 변경 시
if (tbOrder.CallCustName != (sTmp = Std32Window.GetWindowCaption(wndRcpt.의뢰자_hWnd고객명)))
{
    nChanged = nChanged == 0 ? 1 : nChanged;  // 첫 변경이면 1
    // 고객명 검색 로직...
}

// 예시 2: 전화1 변경 시
if (tbOrder.CallTelNo != (sTmp = ...))
{
    nChanged = nChanged == 0 ? 3 : nChanged;  // 첫 변경이면 3
    // 전화1 입력 로직...
}
```

**nChanged 값의 의미**:
- `0`: 변경 없음 → 저장 버튼 클릭 불필요
- `1`: 고객명 변경됨 → 고객 재검색 필요
- `3`: 일반 필드 변경됨 → 저장만 필요

#### 변경 체크 패턴:
```csharp
// RegistOrder (등록): 무조건 입력
if (!await WriteAndVerifyEditBoxAsync(...))
    return Error();

// UpdateOrder (수정): 변경된 항목만 입력
string currentValue = Std32Window.GetWindowCaption(hWnd);
if (expectedValue != currentValue)  // 다를 때만 입력
{
    nChanged = nChanged == 0 ? 3 : nChanged;

    if (!await WriteAndVerifyEditBoxAsync(...))
        return Error();
}
```

### 7.3 공통 함수 수정 필요

기존 `WriteAndVerifyEditBoxAsync`를 **등록/수정 통합 버전**으로 개선:

```csharp
/// <summary>
/// EditBox에 값을 입력하고 검증 (재시도 포함)
/// </summary>
/// <param name="isUpdateMode">수정 모드 여부 (true=변경 체크, false=무조건 입력)</param>
/// <param name="nChanged">변경 추적 변수 (수정 모드 전용)</param>
/// <param name="changeLevel">변경 레벨 (1=고객명, 3=일반 필드)</param>
private async Task<(bool success, int nChanged)> WriteAndVerifyEditBoxAsync(
    IntPtr hWnd,
    string expectedValue,
    string fieldName,
    Func<string, string> normalizer = null,
    bool useEnterKey = false,
    bool isUpdateMode = false,
    int nChanged = 0,
    int changeLevel = 3)
{
    normalizer = normalizer ?? (s => s);

    // 1. 현재 값 읽기
    string currentValue = normalizer(Std32Window.GetWindowCaption(hWnd));

    // 2. 수정 모드: 같으면 스킵
    if (isUpdateMode && expectedValue == currentValue)
        return (true, nChanged);  // 변경 없음

    // 3. 수정 모드: 다르면 nChanged 업데이트
    if (isUpdateMode)
        nChanged = nChanged == 0 ? changeLevel : nChanged;

    // 4. 입력 (등록/수정 공통)
    for (int i = 0; i < c_nRepeatShort; i++)
    {
        if (useEnterKey)
            await OfrWork_Common.WriteEditBox_ToHndleAsync_WithEnterKeyWait(hWnd, expectedValue);
        else
            await OfrWork_Common.WriteEditBox_ToHndleAsync(hWnd, expectedValue);

        currentValue = normalizer(Std32Window.GetWindowCaption(hWnd));
        if (expectedValue == currentValue)
            return (true, nChanged);

        await Task.Delay(c_nWaitNormal);
    }

    Debug.WriteLine($"[{fieldName}] 입력 실패: 기대={expectedValue}, 실제={currentValue}");
    return (false, nChanged);
}
```

### 7.4 등록/수정 통합 구조

```csharp
/// <summary>
/// 신규 등록
/// </summary>
public async Task<RegistResult> RegistOrderToPopupAsync(
    AutoAlloc item,
    IntPtr hWndPopup,
    CancelTokenControl ctrl)
{
    TbOrder order = item.NewOrder;
    var wndRcpt = new RcptWnd_New(hWndPopup, m_Context.FileInfo);

    // 입력 로직 (isUpdateMode=false, nChanged 불필요)
    var result = await InputAllFieldsAsync(order, wndRcpt, ctrl, isUpdateMode: false);
    if (!result.Success) return result;

    // 저장
    return await SaveNewOrderAsync(order, wndRcpt, ctrl);
}

/// <summary>
/// 수정
/// </summary>
public async Task<RegistResult> UpdateOrderInPopupAsync(
    AutoAlloc item,
    IntPtr hWndPopup,
    CancelTokenControl ctrl)
{
    TbOrder order = item.NewOrder;
    var wndRcpt = new RcptWnd_Edit(hWndPopup, m_Context.FileInfo);

    // 입력 로직 (isUpdateMode=true, nChanged 추적)
    int nChanged = 0;
    var (result, changedFlag) = await InputAllFieldsAsync(
        order, wndRcpt, ctrl, isUpdateMode: true, nChanged);

    if (!result.Success) return result;

    // 변경 없으면 저장 스킵
    if (changedFlag == 0)
    {
        Debug.WriteLine("[수정] 변경 사항 없음 → 저장 스킵");
        return RegistResult.SuccessResult();
    }

    // 저장
    return await SaveUpdatedOrderAsync(order, wndRcpt, ctrl);
}

/// <summary>
/// 통합 입력 로직 (등록/수정 공통)
/// </summary>
private async Task<(RegistResult result, int nChanged)> InputAllFieldsAsync(
    TbOrder order,
    object wndRcpt,  // RcptWnd_New or RcptWnd_Edit
    CancelTokenControl ctrl,
    bool isUpdateMode,
    int nChanged = 0)
{
    // 의뢰자, 출발지, 도착지, 기타 정보 입력
    // isUpdateMode에 따라 "변경 체크 → 입력" or "무조건 입력"

    // ... 구현 ...

    return (RegistResult.SuccessResult(), nChanged);
}
```

---

## 8. 공통 함수 요약 (개선)

### 핵심 공통 함수 5개:

1. **WriteAndVerifyEditBoxAsync**
   - EditBox 입력 + 검증 (재시도 포함)
   - 전화번호 정규화 등 커스텀 변환 지원

2. **SearchAndSelectCustomerAsync**
   - 고객 검색 → 결과 타입별 처리
   - 의뢰자, 출발지, 도착지 공통

3. **SetAndVerifyCheckBoxAsync**
   - CheckBox 설정 + 검증 (재시도 포함)
   - OFR 이미지 인식 기반

4. **SetAndVerifyRadioButtonAsync**
   - RadioButton Group 설정 + 검증 (재시도 포함)
   - 요금종류, 차량종류 등

5. **SelectComboBoxItemAsync**
   - ComboBox 열림 대기 → 항목 선택
   - 트럭톤수, 트럭상세 등

---

## 9. 다음 작업 단계

### Phase 1: Helper 메서드 구현
1. RcptWnd_New 클래스 정의 (팝업창 핸들 관리)
2. 5개 핵심 공통 함수 구현
3. EnterKeyNGet동명Async 등 보조 함수 구현

### Phase 2: RegistOrderToPopupAsync 구현
1. InputRequesterInfoAsync - 의뢰자 정보
2. InputStartLocationAsync - 출발지 정보
3. InputDestLocationAsync - 도착지 정보
4. InputOtherInfoAsync - 기타 정보
5. SaveOrderAsync - 저장 및 확인

### Phase 3: 주석 처리된 메서드 활성화
1. Click조회버튼Async 리팩토링 후 활성화
2. ClickEmptyRowAsync 리팩토링 후 활성화
3. Simulation_Mouse 메서드들 검토

### Phase 4: UpdateOrderAsync 구현
- RegistOrderAsync와 거의 동일한 패턴
- 차이점: 기존 값 읽기 → 변경된 항목만 업데이트

---

**작성 완료**: 2025-10-25
**다음 세션**: Phase 1 - Helper 메서드 구현
